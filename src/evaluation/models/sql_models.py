"""
FILE: sql_models.py
STATUS: Active
RESPONSIBILITY: Pydantic models for SQL evaluation (QueryType, test cases, execution results, accuracy metrics)
LAST MAJOR UPDATE: 2026-02-13
MAINTAINER: Shahu
"""

from enum import Enum
from typing import Any

from pydantic import BaseModel, Field


class QueryType(str, Enum):
    """Type of query being evaluated."""

    SQL_ONLY = "sql_only"  # Pure statistical query (SQL tool only)
    CONTEXTUAL_ONLY = "contextual_only"  # Pure contextual query (vector only)
    HYBRID = "hybrid"  # Requires both SQL + vector


class SQLEvaluationTestCase(BaseModel):
    """Test case for SQL evaluation."""

    question: str = Field(min_length=1, description="User question")
    query_type: QueryType = Field(description="Query type (SQL/CONTEXTUAL/HYBRID)")
    expected_sql: str | None = Field(default=None, description="Expected SQL query (for SQL/HYBRID)")
    ground_truth_answer: str = Field(min_length=1, description="Correct answer")
    ground_truth_data: dict[str, Any] | list[dict[str, Any]] | None = Field(
        default=None, description="Expected SQL results (for verification, can be dict or list)"
    )
    category: str = Field(description="Category (simple/complex/comparison/aggregation)")
    conversation_thread: str | None = Field(
        default=None,
        description="Conversation thread ID (queries with same ID belong to same conversation)"
    )


class SQLExecutionResult(BaseModel):
    """Result of SQL query execution."""

    query_generated: str | None = Field(description="SQL query generated by LLM")
    query_executed: bool = Field(description="Whether query executed successfully")
    execution_error: str | None = Field(default=None, description="Execution error if any")
    results: list[dict[str, Any]] = Field(default_factory=list, description="Query results")
    formatted_results: str | None = Field(default=None, description="Formatted results for LLM")


class SQLAccuracyMetrics(BaseModel):
    """Metrics for SQL component accuracy."""

    sql_syntax_correct: bool = Field(description="Generated SQL is syntactically valid")
    sql_semantic_correct: bool = Field(
        description="SQL query correctly answers the question"
    )
    results_accurate: bool = Field(description="Results match ground truth")
    execution_success: bool = Field(description="Query executed without errors")

    @property
    def overall_score(self) -> float:
        """Compute overall SQL accuracy score (0-1)."""
        scores = [
            self.sql_syntax_correct,
            self.sql_semantic_correct,
            self.results_accurate,
            self.execution_success,
        ]
        return sum(scores) / len(scores)
